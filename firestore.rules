/**
 * @file Firestore Security Rules for OptiServe ERP
 * @description This ruleset enforces a role-based access control model for the ERP system.
 * Access to different collections is restricted based on the user's role and organization type
 * as defined in their /users/{userId} profile document.
 *
 * Key Security Decisions:
 * - User profiles are private, only writable by the owning user and readable by Admins within the same organization.
 * - Write access to collections (e.g., bookings, tasks) is restricted to specific roles (e.g., Admin, Front Office Staff).
 * - Read access is generally broader for internal staff roles to facilitate operations.
 * - Data is logically partitioned by an "organisationType" field in most documents to prepare for multi-tenant security logic.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to get user data and check roles/permissions.
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if the incoming request's user has one of the specified roles.
    function requestHasRole(allowedRoles) {
      let userRole = getUserData(request.auth.uid).role;
      return isSignedIn() && userRole in allowedRoles;
    }

    // Checks if the user performing the request belongs to a specific organization type.
    function requestIsInOrg(orgTypes) {
        let userOrg = getUserData(request.auth.uid).organisationType;
        return isSignedIn() && userOrg in orgTypes;
    }


    /**
     * @description Manages access to user profile documents.
     * @path /users/{userId}
     * @principle Users can create and manage their own profile.
     */
    match /users/{userId} {
      allow read, update: if isOwner(userId);
      allow create: if request.auth.uid == request.resource.data.uid;
    }

    /**
     * @description Manages bookings for hotels and lodges.
     * @path /bookings/{bookingId}
     * @principle Admins and Front Office staff can manage all bookings.
     */
    match /bookings/{bookingId} {
        allow read, create, update, delete: if requestIsInOrg(['Hotel', 'Lodge']) && requestHasRole(['Admin', 'Front Office Staff', 'Receptionist']);
    }

    /**
     * @description Manages rooms for hotels and lodges.
     * @path /rooms/{roomId}
     * @principle Housekeeping can update status, Front Office and Admins can manage.
     */
    match /rooms/{roomId} {
        allow read: if requestIsInOrg(['Hotel', 'Lodge']) && requestHasRole(['Admin', 'Front Office Staff', 'Receptionist', 'Housekeeping']);
        allow create, update: if requestIsInOrg(['Hotel', 'Lodge']) && requestHasRole(['Admin', 'Front Office Staff', 'Housekeeping']);
    }

    /**
     * @description Manages tasks for all staff.
     * @path /tasks/{taskId}
     * @principle Admins and managers can create/read all tasks. Staff can only update their own assigned tasks.
     */
    match /tasks/{taskId} {
        allow read, create: if requestHasRole(['Admin', 'HR Manager', 'Maintenance Team']);
        allow update: if requestHasRole(['Admin', 'HR Manager']) || (resource.data.assignedToId == request.auth.uid);
    }
    
    /**
     * @description Manages inventory items.
     * @path /inventory/{itemId}
     * @principle Inventory and Restaurant managers can manage inventory.
     */
    match /inventory/{itemId} {
        allow read, write: if requestHasRole(['Admin', 'Inventory Manager', 'Restaurant Manager']);
    }

    /**
     * @description Manages financial transactions.
     * @path /transactions/{transactionId}
     * @principle Finance staff and Admins can manage transactions.
     */
    match /transactions/{transactionId} {
         allow read, write: if requestHasRole(['Admin', 'Finance Manager', 'Finance']);
    }

    /**
     * @description Manages restaurant orders.
     * @path /restaurantOrders/{orderId}
     * @principle Restaurant staff can manage orders.
     */
    match /restaurantOrders/{orderId} {
        allow read, write: if requestIsInOrg(['Restaurant']) && requestHasRole(['Admin', 'Restaurant Manager', 'Chef', 'Waiter']);
    }
  }
}
